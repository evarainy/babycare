<view class="page {{darkMode ? 'page-dark' : ''}}">
  <view class="header">
    <view class="header-top">
      <view class="greeting">
        <text class="greeting-text">{{greetingText}}</text>
        <text class="date-text">{{todayDate}}</text>
      </view>
      <view class="avatar" bindtap="goSettings">
        <image src="{{userAvatar}}" class="avatar-img" mode="aspectFill" />
      </view>
    </view>


    <view class="baby-hero">
      <image class="baby-hero-bg" src="{{babyProfile.photoUrl || userAvatar}}" mode="aspectFill" />
      <view class="baby-hero-overlay"></view>
      <view class="baby-hero-content">
        <view class="baby-main">
          <text class="baby-name">{{babyProfile.name}}</text>
          <text class="baby-age">{{babyProfile.birthday ? ("å‡ºç”Ÿ" + babyProfile.ageText) : "è¯·åœ¨è®¾ç½®é¡µå®Œå–„ç”Ÿæ—¥"}}</text>
          <view class="baby-metrics">
            <text class="baby-metric">ä½“é‡ {{babyProfile.weightG !== "" ? (babyProfile.weightG + "g") : "æœªå¡«å†™"}}</text>
            <text class="baby-metric-divider">Â·</text>
            <text class="baby-metric">èº«é«˜ {{babyProfile.heightCm !== "" ? (babyProfile.heightCm + "cm") : "æœªå¡«å†™"}}</text>
          </view>
        </view>
        <image class="baby-avatar" src="{{babyProfile.photoUrl || userAvatar}}" mode="aspectFill" />
      </view>
    </view>

    <view class="summary-cards">
      <view class="summary-card summary-card-combined">
        <view class="summary-top-label">ä»Šæ—¥å–‚å…»æ¦‚è§ˆ</view>
        <view class="summary-combined-row">
          <view class="summary-kpi-item">
            <text class="summary-kpi-num">{{todaySummary.todayCount}}</text>
            <text class="summary-kpi-label">ä»Šæ—¥æ¬¡æ•°</text>
          </view>
          <view class="summary-kpi-divider"></view>
          <view class="summary-kpi-item">
            <text class="summary-kpi-num {{intervalWarning ? 'warning' : ''}}">{{intervalText}}</text>
            <text class="summary-kpi-label">è·ä¸Šæ¬¡</text>
          </view>
        </view>
      </view>

      <view class="summary-card summary-card-milk">
        <text class="summary-num">{{todaySummary.totalAmount || 0}}</text>
        <text class="summary-label">æ€»å¥¶é‡(ml)</text>
        <view class="milk-breakdown">
          <view class="milk-item">
            <text class="milk-item-label">å¥¶ç²‰</text>
            <text class="milk-item-value">{{todaySummary.formulaAmount || 0}}ml</text>
          </view>
          <view class="milk-item">
            <text class="milk-item-label">æ¯ä¹³</text>
            <text class="milk-item-value">{{todaySummary.breastMilkAmount || 0}}ml</text>
          </view>
        </view>
      </view>

      <view class="summary-card summary-card-food">
        <text class="summary-num">{{todaySummary.foodAmount || 0}}</text>
        <text class="summary-label">è¾…é£Ÿ(g)</text>
        <text class="summary-sub-count">{{todaySummary.foodCount || 0}}æ¬¡</text>
      </view>
    </view>
  </view>

  <view class="quick-actions">
    <view class="quick-title">å¿«é€Ÿè®°å½•</view>
    <view class="quick-btns">
      <view class="quick-btn" bindtap="quickRecord" data-type="breastfeeding">
        <text class="quick-icon">ğŸ¤±</text>
        <text class="quick-text">äº²å–‚</text>
      </view>
      <view class="quick-btn" bindtap="quickRecord" data-type="bottle">
        <text class="quick-icon">ğŸ¼</text>
        <text class="quick-text">ç“¶å–‚</text>
      </view>
      <view class="quick-btn" bindtap="quickRecord" data-type="food">
        <text class="quick-icon">ğŸ¥£</text>
        <text class="quick-text">è¾…é£Ÿ</text>
      </view>
      <view class="quick-btn" bindtap="quickRecord" data-type="swimming">
        <text class="quick-icon">ğŸŠ</text>
        <text class="quick-text">æ¸¸æ³³</text>
      </view>
      <view class="quick-btn" bindtap="quickRecord" data-type="diaper">
        <text class="quick-icon">ğŸ‘¶</text>
        <text class="quick-text">å°¿å¸ƒ</text>
      </view>
    </view>
  </view>

  <view class="voice-section">
    <view class="voice-input-area">
      <input
        class="voice-input"
        placeholder="è¾“å…¥æˆ–è¯­éŸ³æè¿°ï¼Œå¦‚ï¼šå–‚äº†å·¦è¾¹100ml"
        value="{{voiceText}}"
        bindinput="onVoiceInput"
        confirm-type="send"
        bindconfirm="submitVoiceText"
      />
      <view class="voice-btn {{isRecording ? 'recording' : ''}}" bindtouchstart="startRecord" bindtouchend="stopRecord">
        <text class="voice-icon">ğŸ¤</text>
      </view>
    </view>
    <button class="submit-btn" bindtap="submitVoiceText" wx:if="{{voiceText}}">
      AIè§£æå¹¶è®°å½•
    </button>
  </view>

  <view class="timeline-section">
    <view class="flex-between">
      <text class="section-title">ä»Šæ—¥æ—¶é—´è½´</text>
      <text class="view-all" bindtap="goRecord">æŸ¥çœ‹å…¨éƒ¨</text>
    </view>

    <view wx:if="{{todayRecords.length === 0}}" class="empty-state">
      <text>ğŸ¼</text>
      <text>ä»Šå¤©è¿˜æ²¡æœ‰è®°å½•</text>
      <text class="text-small text-gray">ç‚¹å‡»ä¸Šæ–¹å¿«é€Ÿè®°å½•</text>
    </view>

    <view class="timeline" wx:else>
      <view class="timeline-item" wx:for="{{todayRecords}}" wx:key="_id">
        <view class="timeline-dot {{item.type}}"></view>
        <view class="timeline-content card">
          <view class="flex-between">
            <view class="flex-row">
              <text class="record-icon">{{item.typeIcon}}</text>
              <text class="record-type">{{item.typeLabel}}</text>
              <view class="tag tag-pink" wx:if="{{item.feedingType}}">{{item.feedingType}}</view>
              <view class="tag tag-blue" wx:if="{{item.side}}">{{item.sideLabel}}</view>
            </view>
            <text class="record-time">{{item.timeText}}</text>
          </view>
          <view class="record-detail" wx:if="{{item.amount || item.duration}}">
            <text wx:if="{{item.amount}}">{{item.amountText}}</text>
            <text wx:if="{{item.duration}}">{{item.duration}}åˆ†é’Ÿ</text>
          </view>
          <text class="record-note text-gray text-small" wx:if="{{item.note}}">{{item.note}}</text>
          <view class="record-actions">
            <text class="action-btn" bindtap="editRecord" data-id="{{item._id}}">ç¼–è¾‘</text>
            <text class="action-btn danger" bindtap="deleteRecord" data-id="{{item._id}}">åˆ é™¤</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <view class="pending-section" wx:if="{{pendingRecords.length > 0}}">
    <view class="section-title">âš ï¸ å¾…ç¡®è®¤è®°å½•</view>
    <view class="pending-item card" wx:for="{{pendingRecords}}" wx:key="_id">
      <view class="flex-between">
        <text>{{item.typeIcon}} {{item.typeLabel}} {{item.amount}}ml {{item.sideLabel}}</text>
        <view class="flex-row">
          <text class="action-btn" bindtap="confirmRecord" data-id="{{item._id}}">ç¡®è®¤</text>
          <text class="action-btn danger" bindtap="deleteRecord" data-id="{{item._id}}">åˆ é™¤</text>
        </view>
      </view>
      <text class="text-small text-gray">æ¥æºï¼š{{item.source === 'wechat_bot' ? 'å¾®ä¿¡ç¾¤' : 'Siri'}}</text>
    </view>
  </view>
</view>

<view class="quick-modal" wx:if="{{showQuickModal}}">
  <view class="modal-mask" bindtap="closeModal"></view>
  <view class="modal-content">
    <view class="modal-title">å¿«é€Ÿè®°å½• - {{quickModalTitle}}</view>

    <view class="amount-section" wx:if="{{quickModalType === 'breastfeeding'}}">
      <view class="side-btns">
        <view class="side-btn {{quickSide === 'å·¦' ? 'active' : ''}}" bindtap="selectSide" data-side="å·¦">å·¦ä¾§</view>
        <view class="side-btn {{quickSide === 'å³' ? 'active' : ''}}" bindtap="selectSide" data-side="å³">å³ä¾§</view>
        <view class="side-btn {{quickSide === 'åŒ' ? 'active' : ''}}" bindtap="selectSide" data-side="åŒ">åŒä¾§</view>
      </view>
      <text class="amount-label">æ—¶é•¿ (åˆ†é’Ÿ)</text>
      <view class="amount-btns">
        <view class="amount-btn" wx:for="{{durationPresets}}" wx:key="*this" bindtap="selectDuration" data-duration="{{item}}">{{item}}</view>
      </view>
      <input class="amount-input" type="number" placeholder="è‡ªå®šä¹‰æ—¶é•¿" value="{{quickDuration}}" bindinput="onDurationInput" />
    </view>

    <view class="amount-section" wx:if="{{quickModalType === 'bottle'}}">
      <text class="amount-label">ç“¶å–‚ç±»å‹</text>
      <view class="side-btns">
        <view class="side-btn {{quickBottleType === 'å¥¶ç²‰' ? 'active' : ''}}" bindtap="selectBottleType" data-btype="å¥¶ç²‰">å¥¶ç²‰</view>
        <view class="side-btn {{quickBottleType === 'æ¯ä¹³' ? 'active' : ''}}" bindtap="selectBottleType" data-btype="æ¯ä¹³">æ¯ä¹³</view>
        <view class="side-btn {{quickBottleType === 'æ°´' ? 'active' : ''}}" bindtap="selectBottleType" data-btype="æ°´">æ°´</view>
        <view class="side-btn {{quickBottleType === 'è¡¥å‰‚' ? 'active' : ''}}" bindtap="selectBottleType" data-btype="è¡¥å‰‚">è¡¥å‰‚</view>
      </view>
      <text class="amount-label">å¥¶é‡ (ml)</text>
      <view class="amount-btns">
        <view class="amount-btn" wx:for="{{amountPresets}}" wx:key="*this" bindtap="selectAmount" data-amount="{{item}}">{{item}}</view>
      </view>
      <input class="amount-input" type="number" placeholder="è‡ªå®šä¹‰å¥¶é‡" value="{{quickAmount}}" bindinput="onAmountInput" />
    </view>

    <view class="amount-section" wx:if="{{quickModalType === 'food'}}">
      <text class="amount-label">è¾…é£Ÿé‡ (g)</text>
      <view class="amount-btns">
        <view class="amount-btn" wx:for="{{foodPresets}}" wx:key="*this" bindtap="selectAmount" data-amount="{{item}}">{{item}}</view>
      </view>
      <input class="amount-input" type="number" placeholder="è‡ªå®šä¹‰å…‹æ•°" value="{{quickAmount}}" bindinput="onAmountInput" />
    </view>

    <view class="amount-section" wx:if="{{quickModalType === 'swimming'}}">
      <text class="amount-label">æ—¶é•¿ (åˆ†é’Ÿ)</text>
      <view class="amount-btns">
        <view class="amount-btn" wx:for="{{durationPresets}}" wx:key="*this" bindtap="selectDuration" data-duration="{{item}}">{{item}}</view>
      </view>
      <input class="amount-input" type="number" placeholder="è‡ªå®šä¹‰æ—¶é•¿" value="{{quickDuration}}" bindinput="onDurationInput" />
    </view>

    <view class="modal-actions">
      <button class="btn-secondary" bindtap="closeModal">å–æ¶ˆ</button>
      <button class="btn-primary" bindtap="submitQuickRecord">ç¡®è®¤è®°å½•</button>
    </view>
  </view>
</view>

<voice-floating-button bind:recordsuccess="onVoiceRecordSuccess" />
